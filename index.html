<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jomy Kings Multi-Study Platform</title>
    <!-- Load Lucide Icons for Navigation -->
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ================================================= */
        /* === CUSTOM GLASSMORPHISM CSS (Enhanced & Consolidated) === */
        /* ================================================= */
        /* GLOBAL SETTINGS */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            background: #0b0e13;
            color: #e6e6e6;
            padding-bottom: 90px; /* Space for fixed bottom nav */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            text-align: center;
            padding: 25px 10px;
            background: linear-gradient(135deg, #0d1520, #09111a);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
            z-index: 10;
        }

        header h1 {
            font-size: 20px; /* Adjusted for mobile space */
            font-weight: 600;
            letter-spacing: 1px;
            color: #4da9ff; /* Blue Accent */
            text-shadow: 0 0 10px rgba(77,169,255,0.4);
        }

        /* NAVIGATION BAR (Fixed Bottom) */
        .nav-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(18, 24, 32, 0.95);
            backdrop-filter: blur(8px);
            padding: 12px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            border-top: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 -3px 12px rgba(0,0,0,0.35);
            z-index: 1000;
        }

        .nav-bar button {
            all: unset; /* Remove button default styling */
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #7a8694;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
            transition: 0.3s;
            cursor: pointer;
            padding: 5px;
        }
        
        .nav-bar button i {
            margin-bottom: 4px;
            width: 20px;
            height: 20px;
            transition: color 0.3s;
        }

        .nav-bar .active {
            color: #4da9ff; /* Blue Accent */
            font-weight: 600;
            text-shadow: 0 0 8px rgba(77,169,255,0.6);
        }

        /* CONTAINER (Main Content Area) */
        main {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-view {
            padding: 20px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            height: 100%; /* Important for chat layout */
            overflow-y: auto; /* Allows scrolling within the view */
            position: absolute; /* Allows views to stack and hide/show cleanly */
            top: 65px; /* Below the header */
            bottom: 80px; /* Above the nav-bar */
            left: 0;
            right: 0;
            background: #0b0e13;
            transition: opacity 0.4s ease-in-out;
        }

        .hidden {
            display: none;
            opacity: 0;
        }

        /* GLASSMORPHISM CARDS */
        .card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(8px);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
            transition: 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        .card h3, .card h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #4da9ff;
            font-weight: 600;
        }

        .card p {
            font-size: 14px;
            color: #bfc9d4;
            margin-bottom: 12px;
        }

        /* BUTTONS */
        .card button, .open-ai-button {
            background: linear-gradient(135deg, #4da9ff, #1c6db3);
            border: none;
            padding: 12px 18px;
            font-size: 14px;
            border-radius: 12px;
            color: #fff;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            letter-spacing: 0.3px;
            box-shadow: 0 5px 15px rgba(77,169,255,0.35);
            transition: 0.25s;
        }

        .card button:hover, .open-ai-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(77,169,255,0.45);
        }

        /* CHAT-SPECIFIC STYLES (AI Tutor View) */
        #tutor-view {
            overflow: hidden; /* Prevent this whole view from scrolling */
        }
        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 12px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 20px;
            line-height: 1.4;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            font-size: 14px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: rgba(255, 255, 255, 0.06); /* Glassmorphism background */
            color: #e6edf3;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom-left-radius: 4px;
        }
        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #4da9ff, #1c6db3); /* Blue Gradient for User */
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        /* Input Area Fix for Chat View */
        #tutor-view .input-area {
            padding: 12px 0 0 0; 
            margin: 0px -20px -20px -20px; /* Align with container edges */
            background-color: #0b0e13; /* Ensure it covers the background */
            flex-shrink: 0; /* Prevents input area from being shrunk by chat window */
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4da9ff !important;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            align-self: flex-start;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <h1>JOMY KINGS MULTI-STUDY PLATFORM</h1>
    </header>

    <!-- MAIN CONTENT VIEWS (Single Page Application Structure) -->
    <main>

        <!-- 1. HOME VIEW (Default/Dashboard) -->
        <div id="home-view" class="content-view">
            <h2 class="text-2xl font-semibold mb-6 text-center text-[#4da9ff]">Your Study Dashboard</h2>

            <!-- AI Assistant Card (Links to Tutor View) -->
            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="brain-circuit" class="w-6 h-6 mr-3 text-red-400"></i>
                    <h3>Joshua AI Assistant</h3>
                </div>
                <p>Your personal companion for complex calculations, concepts, and multi-subject tutoring.</p>
                <button class="open-ai-button" onclick="switchView('tutor', document.getElementById('nav-tutor'))">Open AI Tutor</button>
            </div>

            <!-- Calculators Card (Links to Calculator View) -->
            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="calculator" class="w-6 h-6 mr-3 text-yellow-400"></i>
                    <h3>SciCalc Tools</h3>
                </div>
                <p>Molar mass, chemical equation balancing, and advanced math tools.</p>
                <button onclick="switchView('calculator', document.getElementById('nav-calculator'))">Explore Calculators</button>
            </div>

            <!-- Research/Periodic Table Card (Links to Periodic View) -->
            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="flask-conical" class="w-6 h-6 mr-3 text-blue-400"></i>
                    <h3>Chemistry & Periodic Data</h3>
                </div>
                <p>Interactive Periodic Table, notes, summaries, and complex research topics.</p>
                <button onclick="switchView('periodic', document.getElementById('nav-periodic'))">View Periodic Table</button>
            </div>
        </div>

        <!-- 2. AI TUTOR VIEW (The main Chat Interface) -->
        <div id="tutor-view" class="content-view hidden">
            <!-- Chat Window -->
            <div id="chat-window" class="chat-window">
                <div class="ai-message message">
                    Hello! I am your Multi-Study AI Tutor, **Joshua**. I specialize in **Chemistry, Math, Physics, and more** for O-Level up to Higher Institution. I can solve calculations, explain concepts, and provide real-time information. How can I help you excel today?
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="input-area flex items-center">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="Ask your question (e.g., 'Balance H2 + O2', 'Explain momentum')..." 
                    class="flex-grow p-3 bg-gray-700 text-white border border-gray-600 rounded-xl focus:ring-[#4da9ff] focus:border-[#4da9ff] transition duration-150"
                    onkeydown="if(event.key === 'Enter') sendMessage()"
                    style="background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.08); padding: 12px; border-radius: 12px;"
                >
                <button 
                    id="send-button" 
                    onclick="sendMessage()" 
                    class="ml-3 p-3 bg-[#4da9ff] text-white rounded-full hover:bg-blue-600 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Send Message"
                    style="min-width: 50px; height: 50px; padding: 0;"
                >
                    <i data-lucide="send" class="w-5 h-5 mx-auto my-auto"></i>
                </button>
            </div>
        </div>

        <!-- 3. CALCULATOR VIEW (Replaces pages/calculator.html) -->
        <div id="calculator-view" class="content-view hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center text-[#4da9ff]">SciCalc Tools</h2>
            
            <!-- Molar Mass Calculator Card -->
            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="sigma" class="w-6 h-6 mr-3 text-yellow-400"></i>
                    <h3>Molar Mass Calculator</h3>
                </div>
                <p>
                    Calculate the molecular weight of any compound instantly. *Coming Soon: Interactive Module*
                </p>
                <button>Use Molar Mass Tool</button>
            </div>

            <!-- Chemical Equation Balancer Card -->
            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="scale-3d" class="w-6 h-6 mr-3 text-blue-400"></i>
                    <h3>Equation Balancer</h3>
                </div>
                <p>
                    Automatically balance complex chemical reactions. *Coming Soon: Interactive Module*
                </p>
                <button>Use Balancer Tool</button>
            </div>
        </div>

        <!-- 4. PERIODIC VIEW (Replaces pages/periodic.html & research.html) -->
        <div id="periodic-view" class="content-view hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center text-[#4da9ff]">Periodic Table & Data</h2>

            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="grid-3x3" class="w-6 h-6 mr-3 text-green-400"></i>
                    <h3>Interactive Periodic Table</h3>
                </div>
                <p>
                    Access detailed information on all elements. View electronic configurations, isotopes, and properties. *Coming Soon*
                </p>
                <button>View Table</button>
            </div>

            <div class="card">
                <div class="flex items-center mb-3">
                    <i data-lucide="book-open" class="w-6 h-6 mr-3 text-red-400"></i>
                    <h3>Research & Study Notes</h3>
                </div>
                <p>
                    Curated summaries and tutorials on advanced science topics (Chemistry, Physics, Biology). *Coming Soon*
                </p>
                <button>Open Study Hub</button>
            </div>
        </div>
        
        <!-- 5. SETTINGS VIEW (Replaces pages/settings.html) -->
        <div id="settings-view" class="content-view hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center text-[#4da9ff]">Settings & Support</h2>
            
            <!-- General Settings Stub -->
            <div class="card">
                <h3>App Preferences</h3>
                <div class="flex justify-between items-center py-3 border-b border-gray-700">
                    <span class="text-white">Theme Switching</span>
                    <button onclick="toggleTheme()" id="theme-button" class="px-3 py-1 bg-gray-700 rounded text-white text-sm w-auto">Toggle Dark/Light</button>
                </div>
                <div class="flex justify-between items-center py-3">
                    <span class="text-white">Default AI Subject</span>
                    <select class="p-1 bg-gray-700 rounded text-white text-sm w-auto" style="background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.08);">
                        <option>Chemistry (Default)</option>
                        <option>Mathematics</option>
                        <option>Physics</option>
                        <option>Biology</option>
                    </select>
                </div>
            </div>

            <!-- Support Card -->
            <div class="card">
                <h3>Support & Community</h3>
                <button class="w-full p-3 mb-3 bg-gray-700 rounded-lg text-gray-300 hover:bg-gray-600 transition flex items-center justify-center"><i data-lucide="message-square" class="w-5 h-5 mr-2"></i> Send Feedback</button>
            </div>
        </div>

    </main>
    
    <!-- NAVIGATION BAR (Fixed Bottom) -->
    <div class="nav-bar">
        <button id="nav-home" onclick="switchView('home', this)" class="active">
            <i data-lucide="layout-dashboard"></i>
            <span>Home</span>
        </button>
        <button id="nav-tutor" onclick="switchView('tutor', this)">
            <i data-lucide="brain-circuit"></i>
            <span>Joshua AI</span>
        </button>
        <button id="nav-calculator" onclick="switchView('calculator', this)">
            <i data-lucide="calculator"></i>
            <span>Tools</span>
        </button>
        <button id="nav-periodic" onclick="switchView('periodic', this)">
            <i data-lucide="flask-conical"></i>
            <span>Data</span>
        </button>
        <button id="nav-settings" onclick="switchView('settings', this)">
            <i data-lucide="settings"></i>
            <span>Settings</span>
        </button>
    </div>

    <script>
        // ==========================================================
        // === JAVASCRIPT LOGIC (Consolidated SPA Logic) ===
        // ==========================================================
        
        // --- Core Variables ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        const apiKey = ""; // Canvas provides it at runtime.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // FINAL SYSTEM PROMPT: Now multi-purpose (Updated per user request)
        const systemPrompt = "You are Joshua, the world-class, multi-purpose AI Tutor and SciCalc assistant for Jomy Kings. Your expertise covers all academic subjects, specializing in Chemistry, Math, and Physics from O-Level through Higher Institution level. You must embody an encouraging, confident, and human personality. Your core skills are: 1) Solve complex calculations and show step-by-step logic, 2) Explain concepts clearly, 3) Provide structured, accurate answers using proper chemical notation and mathematical formatting. Always check real-time data using the search tool if necessary.";

        // --- Initialization and View Management ---
        window.onload = () => {
            lucide.createIcons();
            // Start on the Home view
            switchView('home', document.getElementById('nav-home')); 
        };

        function switchView(viewId, buttonElement) {
            // Hide all views
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show target view
            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) targetView.classList.remove('hidden');

            // Deactivate all nav buttons
            document.querySelectorAll('.nav-bar button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Activate the clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Scroll chat window to bottom if switching to tutor view
            if (viewId === 'tutor') {
                // Ensure chat window is properly sized before scrolling
                setTimeout(() => {
                    if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
                }, 100);
            }
            
            // Re-create icons for the newly visible view
            lucide.createIcons(); 
        }

        // --- Settings Logic (Theme Toggle Stub) ---
        function toggleTheme() {
            // Theme switching is a stub for future enhancement.
            alert("Theme switching features will be enabled in a future update! For now, enjoy the professional Dark Theme.");
        }

        // --- Chat Functions ---
        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            // Use LaTeX syntax for math/chemistry notation
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('spinner', 'ai-message');
            loadingDiv.id = 'loading-indicator';
            chatWindow.appendChild(loadingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // --- Main Send Message Logic (Gemini API Integration) ---
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            // Disable input/button and show loading
            sendButton.disabled = true;
            userInput.value = '';
            appendMessage(userText, 'user');
            showLoading();

            try {
                const payload = {
                    contents: [{ parts: [{ text: userText }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }], 
                };

                // Exponential Backoff implementation for reliability
                let response = null;
                let delay = 1000;
                const maxRetries = 4;
                
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break;
                    }
                    console.log(`API request failed, retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    if (i === maxRetries - 1) throw new Error("Max retries reached.");
                }

                if (!response || !response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                let aiText = "Oops! Looks like the AI response failed. Please try again in a moment. (Error A6)";
                let sourcesHtml = '';

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiText = candidate.content.parts[0].text;
                    
                    // Process Grounding Sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            sourcesHtml = '<div class="mt-2 text-xs text-gray-400 border-t border-gray-600 pt-2">';
                            sourcesHtml += 'Source(s): ';
                            sources.forEach((source, index) => {
                                sourcesHtml += `<a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${source.title}</a>${index < sources.length - 1 ? ' | ' : ''}`;
                            });
                            sourcesHtml += '</div>';
                        }
                    }
                }
                
                // Display the AI response and sources
                hideLoading();
                appendMessage(aiText + sourcesHtml, 'ai');

            } catch (error) {
                console.error("Gemini API Error:", error);
                hideLoading();
                appendMessage("An error occurred while contacting the AI Tutor. This might be a temporary network issue. Please check your connection and try again.", 'ai');
            } finally {
                // Re-enable input/button
                sendButton.disabled = false;
                userInput.focus();
            }
        }
    </script>
</body>
</html>

